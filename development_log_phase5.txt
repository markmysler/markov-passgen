## Phase 5: Multi-Corpus Features - Development Log

### Date: [2025]
**Developer**: AI Assistant  
**Phase**: Multi-Corpus Features  
**Development Time**: ~1 hour  
**Commit Hash**: [Pending]

---

## Objectives Completed ✅

Phase 5 successfully implemented multi-corpus support, allowing users to combine multiple text sources with configurable weighting to control the influence of each corpus on password generation.

### Core Features Implemented

1. **MultiCorpusManager** (`src/markov_passgen/core/multi_corpus_manager.py`)
   - Add/remove corpus sources with unique identifiers
   - Configurable weights for each corpus (default: 1.0)
   - Merge corpora with proportional weighting
   - Support for text cleaner integration
   - Corpus statistics tracking
   - Factory method `from_files()` for batch loading

2. **CLI Enhancements** (`src/markov_passgen/cli.py`)
   - New flags:
     - `--corpus-list`: Repeatable flag for multiple corpus files
     - `--corpus-weights`: Comma-separated weight values (e.g., "1.0,2.0,1.5")
   - Mutually exclusive with existing `--corpus` flag
   - Validates weight count matches corpus count
   - Displays per-corpus statistics

3. **Weight Management**
   - Dynamic weight adjustment with `set_weight()`
   - Weight normalization during merge
   - Proportional repetition algorithm (10x base)
   - Support for highly skewed weights (0.1 to 10.0+)

---

## Technical Implementation

### Architecture Decisions

1. **Weight Application Strategy**
   - Weights applied through repetition (not probability modification)
   - Normalized weights scaled to 10x base repetitions
   - Ensures consistent influence across corpus sizes

2. **Text Cleaner Integration**
   - Applied uniformly to all corpora during load
   - Maintains consistency across merged corpus
   - Optional parameter for selective preprocessing

3. **CLI Design**
   - Backward compatible with single-corpus mode
   - Clear error messages for invalid usage
   - Per-corpus statistics display

### Code Quality Metrics

- **Total Statements**: 71 (multi_corpus_manager.py)
- **Test Coverage**: 100% (multi_corpus_manager.py), 88% overall
- **Tests Added**: 51 (37 unit + 14 integration)
- **Test Pass Rate**: 215/215 (100%)

---

## Testing Strategy

### Unit Tests (37 tests)
- **Initialization**: Empty manager creation
- **Add/Remove**: File/text corpus addition, weight validation, duplicate detection
- **Weighting**: Get/set weights, invalid values, dynamic updates
- **Merging**: Equal/different weights, normalization, empty corpus handling
- **Statistics**: Corpus stats, listing, counting
- **Factory Method**: `from_files()` with weights, cleaner integration, validation
- **Edge Cases**: Invalid weights, nonexistent files, duplicate names

### Integration Tests (14 tests)
- **Generation**: Two/three corpora, equal/different weights
- **Filters**: Length/character filters with multi-corpus
- **Entropy**: Threshold-based generation with merged corpora
- **Transformers**: Leet speak, case variation with multi-corpus
- **Text Cleaning**: Cleaner applied to all sources
- **Weight Adjustment**: Dynamic weight changes during generation
- **Determinism**: Seed-based reproducibility
- **Edge Cases**: Small corpora, highly skewed weights

---

## Examples

### Basic Multi-Corpus Usage

```bash
# Load two corpora with equal weights (default)
markov-passgen generate \
  --corpus-list english.txt \
  --corpus-list tech.txt \
  --count 50 \
  --length 12

# Load three corpora with custom weights
markov-passgen generate \
  --corpus-list english.txt \
  --corpus-list tech.txt \
  --corpus-list names.txt \
  --corpus-weights "1.0,2.0,0.5" \
  --count 50 \
  --length 12
```

### With Text Preprocessing

```bash
# Apply lowercase and punctuation removal to all corpora
markov-passgen generate \
  --corpus-list corpus1.txt \
  --corpus-list corpus2.txt \
  --lowercase \
  --remove-punctuation \
  --count 100
```

### With Filters and Transformers

```bash
# Multi-corpus with character filters and leet speak
markov-passgen generate \
  --corpus-list english.txt \
  --corpus-list tech.txt \
  --require-uppercase \
  --require-digits \
  --leet-speak 0.5 \
  --count 50
```

---

## API Usage

### Programmatic Multi-Corpus Management

```python
from markov_passgen.core.multi_corpus_manager import MultiCorpusManager
from markov_passgen.core.ngram_builder import NGramBuilder
from markov_passgen.core.generator import PasswordGenerator

# Create manager
manager = MultiCorpusManager()

# Add corpora with different weights
manager.add_corpus("english", "english.txt", weight=1.0)
manager.add_corpus("tech", "tech.txt", weight=2.0)
manager.add_corpus("names", "names.txt", weight=0.5)

# View statistics
stats = manager.get_corpus_stats()
for name, corpus_stats in stats.items():
    print(f"{name}: {corpus_stats['word_count']} words, weight={corpus_stats['weight']}")

# Get merged corpus
merged = manager.get_merged_corpus()

# Build model and generate
builder = NGramBuilder()
model = builder.build(merged, n=2)
generator = PasswordGenerator(model)
passwords = generator.generate(50, length=12)

# Adjust weights dynamically
manager.set_weight("tech", 5.0)
merged_updated = manager.get_merged_corpus()
# Rebuild model with new weights...
```

### Factory Method

```python
# Quick setup from file list
manager = MultiCorpusManager.from_files(
    ["corpus1.txt", "corpus2.txt", "corpus3.txt"],
    weights=[1.0, 2.0, 1.5]
)

# With text cleaner
from markov_passgen.transformers.text_cleaner import TextCleaner
cleaner = TextCleaner(lowercase=True, remove_punctuation=True)
manager = MultiCorpusManager.from_files(
    ["corpus1.txt", "corpus2.txt"],
    cleaner=cleaner
)
```

---

## Performance Characteristics

### Weight Normalization
- O(n) where n = number of corpora
- Minimal overhead for typical 2-5 corpus scenarios

### Corpus Merging
- Repetition-based: O(m * r) where m = corpus size, r = repetitions (max 10)
- Memory efficient: concatenates in single pass
- Deterministic output for given weights

### Edge Case Handling
- **Small Corpora**: Minimum 1 repetition ensures influence
- **Skewed Weights**: Normalized proportionally (0.1:10.0 → 1:100)
- **Many Corpora**: Tested up to 3, scales linearly

---

## Issues Encountered & Resolved

### Issue 1: Filter Method Call Errors
**Problem**: Integration tests called `.apply()` on filters instead of `.filter()`  
**Resolution**: Updated test calls to use correct `.filter()` method  
**Files Modified**: `tests/integration/test_phase5_integration.py`  
**Test Results**: 12/14 → 14/14 passing

---

## Coverage Analysis

### Phase 5 Coverage
- **multi_corpus_manager.py**: 100% (71/71 statements)
- **Overall Project**: 88% (642/733 statements)

### Remaining Gaps
- **CLI**: 57% (primarily untested CLI paths)
- **Generator**: 76% (some edge case paths)
- **EntropyCalculator**: 93% (crack time estimation edge cases)

---

## Files Modified/Created

### New Files (3)
1. `src/markov_passgen/core/multi_corpus_manager.py` (71 statements)
2. `tests/unit/test_multi_corpus_manager.py` (37 tests)
3. `tests/integration/test_phase5_integration.py` (14 tests)

### Modified Files (1)
1. `src/markov_passgen/cli.py` (+29 statements, 102 → 131 total)
   - Added `--corpus-list` and `--corpus-weights` flags
   - Multi-corpus loading logic
   - Weight validation and parsing

---

## Lessons Learned

1. **Weighting Strategy**: Repetition-based approach simpler than probability modification
2. **CLI Design**: Mutually exclusive flags prevent user confusion
3. **Test Coverage**: Filter method naming caused initial failures - consistent naming critical
4. **Factory Methods**: `from_files()` provides clean API for common use case

---

## Next Steps (Phase 6)

As per development plan:

1. **Visualization Features**
   - N-gram frequency analysis
   - Entropy distribution plots
   - Corpus comparison charts
   - Export to PNG/SVG

2. **Additional Requirements**
   - matplotlib/seaborn integration
   - CLI flags for visualization options
   - Integration with existing pipeline
   - Interactive vs. save-to-file modes

---

## Test Summary

```
Total Tests: 215
Passed: 215 (100%)
Failed: 0
Skipped: 0

Coverage: 88% (642/733 statements)
Phase 5 Coverage: 100% (71/71 statements)

Test Breakdown:
- Unit: 178 tests
- Integration: 31 tests
- E2E: 6 tests
```

---

## Acceptance Criteria Status

- ✅ Load multiple corpus files
- ✅ Weight corpus influence with configurable values
- ✅ CLI support for multi-corpus options
- ✅ Tests covering multi-corpus scenarios
- ✅ Coverage >= 85% (achieved 88%)
- ✅ All existing tests still pass
- ✅ Clean integration with existing features

**Phase 5 Status**: ✅ **COMPLETE**
